{% extends "base.html" %}

{% block content %}
<div class="monitor-page" style="max-width: 1400px; margin: 0 auto; padding: 2rem;">
    <header class="page-header" style="display: flex; justify-content: space-between; align-items: center;">
        <div>
            <h2>üìä System Monitor</h2>
            <p class="subtitle">Real-time backend performance and activity monitoring</p>
        </div>
        <div style="display: flex; gap: 1rem; align-items: center;">
            <span id="last-update" style="font-size: 0.875rem; color: var(--text-muted);">
                Last updated: Just now
            </span>
            <label class="toggle" title="Auto-refresh every 5 seconds">
                <input type="checkbox" id="auto-refresh" checked>
                <span class="toggle-slider"></span>
            </label>
            <span style="font-size: 0.875rem;">Auto-refresh</span>
        </div>
    </header>

    <!-- System Status Grid -->
    <div class="stats-grid" style="margin-bottom: 2rem;">
        <!-- CPU Usage -->
        <div class="metric-card glass-card">
            <div class="metric-label">üíª CPU Usage</div>
            <div class="metric-value" id="cpu-usage">--</div>
            <div class="metric-change" id="cpu-status">
                Loading...
            </div>
        </div>

        <!-- Memory Usage -->
        <div class="metric-card glass-card">
            <div class="metric-label">üß† Memory</div>
            <div class="metric-value" id="memory-usage">--</div>
            <div style="font-size: 0.875rem; color: var(--text-muted); margin-top: 0.5rem;" id="memory-detail">
                -- / -- GB
            </div>
        </div>

        <!-- Disk Usage -->
        <div class="metric-card glass-card">
            <div class="metric-label">üíæ Disk Usage</div>
            <div class="metric-value" id="disk-usage">--</div>
            <div style="font-size: 0.875rem; color: var(--text-muted); margin-top: 0.5rem;" id="disk-detail">
                -- / -- GB
            </div>
        </div>

        <!-- Total Posts -->
        <div class="metric-card glass-card">
            <div class="metric-label">üìù Total Posts</div>
            <div class="metric-value" id="total-posts">{{ stats.total_posted }}</div>
            <div style="font-size: 0.875rem; color: var(--text-muted); margin-top: 0.5rem;">
                All time
            </div>
        </div>
    </div>

    <!-- API Connection Status -->
    <div class="section-header">
        <h3 class="section-title">
            <span style="font-size: 1.5rem;">üîå</span>
            API Connections
        </h3>
    </div>

    <div class="glass-card" style="padding: 2rem; margin-bottom: 2rem;">
        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 2rem;">
            <!-- Twitter API -->
            <div style="display: flex; align-items: center; gap: 1rem;">
                <div style="font-size: 3rem;">üê¶</div>
                <div style="flex: 1;">
                    <div style="font-weight: 600; color: var(--text-primary); margin-bottom: 0.25rem;">
                        Twitter API
                    </div>
                    <div id="twitter-status">
                        {% if stats.twitter_connected %}
                        <span style="color: var(--accent-success);">‚óè Connected</span>
                        {% else %}
                        <span style="color: var(--accent-error);">‚óè Disconnected</span>
                        {% endif %}
                    </div>
                </div>
            </div>

            <!-- AI Engine -->
            <div style="display: flex; align-items: center; gap: 1rem;">
                <div style="font-size: 3rem;">ü§ñ</div>
                <div style="flex: 1;">
                    <div style="font-weight: 600; color: var(--text-primary); margin-bottom: 0.25rem;">
                        AI Engine (Gemini)
                    </div>
                    <div id="ai-status">
                        {% if stats.ai_connected %}
                        <span style="color: var(--accent-success);">‚óè Active</span>
                        {% else %}
                        <span style="color: var(--accent-error);">‚óè Offline</span>
                        {% endif %}
                    </div>
                </div>
            </div>

            <!-- RSS Feeds -->
            <div style="display: flex; align-items: center; gap: 1rem;">
                <div style="font-size: 3rem;">üì°</div>
                <div style="flex: 1;">
                    <div style="font-weight: 600; color: var(--text-primary); margin-bottom: 0.25rem;">
                        RSS Feeds
                    </div>
                    <div id="rss-status">
                        <span style="color: var(--accent-success);">‚óè {{ stats.rss_feeds }} sources active</span>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Live Activity Log -->
    <div class="section-header">
        <h3 class="section-title">
            <span style="font-size: 1.5rem;">üìã</span>
            Live Activity Log
        </h3>
        <button id="clear-logs" class="btn btn-secondary btn-sm">
            Clear View
        </button>
    </div>

    <div class="glass-card" style="padding: 1.5rem;">
        <div id="activity-log" style="max-height: 400px; overflow-y: auto;">
            <div id="log-entries" style="font-family: 'Courier New', monospace; font-size: 0.875rem; line-height: 1.6;">
                <div style="color: var(--text-muted); text-align: center; padding: 2rem;">
                    Loading activity logs...
                </div>
            </div>
        </div>
    </div>

    <!-- Performance Chart Placeholder -->
    <div class="section-header" style="margin-top: 2rem;">
        <h3 class="section-title">
            <span style="font-size: 1.5rem;">üìà</span>
            Performance Metrics
        </h3>
    </div>

    <div class="glass-card" style="padding: 2rem; text-align: center;">
        <div style="opacity: 0.5;">
            <div style="font-size: 3rem; margin-bottom: 1rem;">üìä</div>
            <div style="color: var(--text-muted);">
                Performance charts coming soon
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
    // Monitor Page - Live Stats
    let autoRefresh = true;
    let refreshInterval;

    // Update stats from API
    async function updateStats() {
        try {
            const response = await fetch('/api/monitor/stats');
            const data = await response.json();

            if (data.error) {
                console.error('Stats error:', data.error);
                return;
            }

            // Update system stats
            if (data.system) {
                document.getElementById('cpu-usage').textContent = data.system.cpu_percent + '%';
                document.getElementById('memory-usage').textContent = data.system.memory_percent + '%';
                document.getElementById('memory-detail').textContent =
                    `${data.system.memory_used_gb} / ${data.system.memory_total_gb} GB`;
                document.getElementById('disk-usage').textContent = data.system.disk_percent + '%';
                document.getElementById('disk-detail').textContent =
                    `${data.system.disk_used_gb} / ${data.system.disk_total_gb} GB`;

                // Update status colors
                const cpuStatus = document.getElementById('cpu-status');
                if (data.system.cpu_percent < 50) {
                    cpuStatus.className = 'metric-change positive';
                    cpuStatus.textContent = 'Normal';
                } else if (data.system.cpu_percent < 80) {
                    cpuStatus.className = 'metric-change';
                    cpuStatus.textContent = 'Moderate';
                    cpuStatus.style.background = 'rgba(245, 158, 11, 0.1)';
                    cpuStatus.style.color = 'var(--accent-warning)';
                } else {
                    cpuStatus.className = 'metric-change negative';
                    cpuStatus.textContent = 'High';
                }
            }

            // Update application stats
            if (data.application) {
                document.getElementById('total-posts').textContent = data.application.total_posts;
            }

            // Update activity logs
            if (data.recent_logs && data.recent_logs.length > 0) {
                const logEntries = document.getElementById('log-entries');
                logEntries.innerHTML = data.recent_logs.map(log => {
                    let color = 'var(--text-secondary)';
                    if (log.includes('ERROR')) color = 'var(--accent-error)';
                    else if (log.includes('WARNING')) color = 'var(--accent-warning)';
                    else if (log.includes('INFO')) color = 'var(--accent-success)';

                    return `<div style="color: ${color}; margin-bottom: 0.5rem;">${escapeHtml(log)}</div>`;
                }).join('');
            }

            // Update timestamp
            const now = new Date();
            document.getElementById('last-update').textContent =
                `Last updated: ${now.toLocaleTimeString()}`;

        } catch (error) {
            console.error('Failed to update stats:', error);
        }
    }

    // Escape HTML to prevent XSS
    function escapeHtml(text) {
        const div = document.createElement('div');
        div.textContent = text;
        return div.innerHTML;
    }

    // Auto-refresh toggle
    document.getElementById('auto-refresh').addEventListener('change', function () {
        autoRefresh = this.checked;

        if (autoRefresh) {
            updateStats();
            refreshInterval = setInterval(updateStats, 5000); // Update every 5 seconds
            showToast('Auto-refresh enabled', 'success');
        } else {
            if (refreshInterval) clearInterval(refreshInterval);
            showToast('Auto-refresh disabled', 'info');
        }
    });

    // Clear logs button
    document.getElementById('clear-logs').addEventListener('click', function () {
        document.getElementById('log-entries').innerHTML =
            '<div style="color: var(--text-muted); text-align: center; padding: 2rem;">Log view cleared. Refresh to reload.</div>';
    });

    // Initial load
    updateStats();

    // Start auto-refresh
    if (autoRefresh) {
        refreshInterval = setInterval(updateStats, 5000);
    }

    // Cleanup on page unload
    window.addEventListener('beforeunload', () => {
        if (refreshInterval) clearInterval(refreshInterval);
    });

    console.log('üìä Monitor page loaded with live stats');
</script>
{% endblock %}